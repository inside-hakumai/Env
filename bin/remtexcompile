#!/usr/bin/env python

import subprocess
import os
import sys
import glob

TEX_HOST      = os.getenv("TEX_HOST",      False)
TEX_HOST_USER = os.getenv("TEX_HOST_USER", False)
TEX_HOST_PORT = os.getenv("TEX_HOST_PORT", False)
TEX_ADDRESS   = TEX_HOST_USER + "@" + TEX_HOST

SSH_COMMAND   = "ssh -p {0} {1}".format(TEX_HOST_PORT, TEX_ADDRESS)
CWD           = os.getcwd()


if __name__ == "__main__":

   if not len(sys.argv) is 2:
      exit(1)

   file_name = sys.argv[1]
   if file_name.endswith(".tex"):
       file_name = file_name.replace(".tex", "")
     
   if not (TEX_HOST and TEX_HOST_USER and TEX_HOST_PORT):
      print("ERROR: Specify TEX_HOST and TEX_HOST_USER and TEX_HOST_PORT as environment variables.".format(CWD), file=sys.stderr)
      exit(1)

   if len(glob.glob(CWD + "/*.tex")) == 0:
      print("ERROR: No tex file is found in {0}".format(CWD), file=sys.stderr)
      exit(1)


   COMMANDS = [
      "[ -d {0}/out ] || mkdir {0}/out/ 2>/dev/null".format(CWD),
      "{0} 'mkdir -p ~/.textmp/data'".format(SSH_COMMAND),
      "rsync -av {0}/ {1}:~/.textmp/data -e ssh --delete --rsh='ssh -p {2}' --exclude='out/'".format(CWD, TEX_ADDRESS, TEX_HOST_PORT),
      # "scp -P {0} -r {1}/** {2}:~/.textmp".format(TEX_HOST_PORT, CWD, TEX_ADDRESS),
      "{0} 'cd ~/.textmp && make FILE={1}'".format(SSH_COMMAND, file_name),
      "scp -P {0} {1}:~/.textmp/data/{2}.pdf {3}/out/".format(TEX_HOST_PORT, TEX_ADDRESS, file_name, CWD),
      # "{0} 'rm -rf  ~/.textmp'".format(SSH_COMMAND)
   ]
   
   for cmd in COMMANDS:
      subprocess.check_call(cmd, shell=True)
